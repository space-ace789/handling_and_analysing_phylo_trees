---
title: "Trees in R Assignment"
output:
  html_document:
      toc: true
      toc_depth: 2
      theme:
        bootswatch: cerulean
---

## Abstract

The tree being investigated here is one of all extant pinnipeds alongside 2 outgroups. The branch lengths in the tree is based on were calculated from a weighted matrix produced via analysis of 50 different genes (Hidgon, et. al., 2007). It is comprised of 3 monophyletic families, *Phocidae* (the earless or true seals), *Otariidae* (sealions and fur seals) and Odobenidae (Walruses). The *Odobendiae* only have one extant member and are grouped within the superfamily *Otarioidea* alongside the Otariids. The *Phocidae* are in turn split into two subfamilies, *Monachinae* which is the southern hemisphere seals and *Phocinae* which are the northern hemisphere seals. *Otariidae* are similarly divided into two subfamilies, the *Artocephalinae* also known as fur seals and the *Otariinae* which are the sea lions (Hidgon et. al., 2007).

## Tree Metrics

#### Set up

###### Loading required packages:

```{r load in packages, results='hide', message=FALSE}
library(ape)
library(bslib) #allows access to bootswatch themes for markdown
library(ggplot2)
library(scales)
library(dplyr)
```

###### Loading in the tree:

The raw data for this tree was downloaded from the Open Tree of Life datastore, (McTavish EJ, et. al., 2015), and can be accessed via the following link <https://tree.opentreeoflife.org/curator/study/view/pg_1646/?tab=home>.

```{r reading in tree from newick data}
tree <- read.tree(text = "((((((((((((((Arctocephalus_australis:0.8,Arctocephalus_galapagoensis:0.8):0.3,Arctocephalus_forsteri:1.1):1.9,(Arctocephalus_gazella:0.1,Arctocephalus_tropicalis:0.1):2.9):0.1,(Arctocephalus_philippii:0.3,Arctocephalus_townsendi:0.3):2.8):0.2,Phocarctos_hookeri:3.3):0.9,Arctocephalus_pusillus:4.2):0.2,Otaria_byronia:4.4):0.8,(Eumetopias_jubatus:4.5,Zalophus_californianus:4.5):0.7):0.4,Neophoca_cinerea:5.6):2.6,Callorhinus_ursinus:8.2):9.8,Odobenus_rosmarus:18):5,(((Cystophora_cristata:7.9,(((((Halichoerus_grypus:1.7,Pusa_caspica:1.7):0.1,Pusa_sibirica:1.8):0.1,(Phoca_largha:0.9,Phoca_vitulina:0.9):1):0.2,Pusa_hispida:2.1):4.3,(Histriophoca_fasciata:4.3,Pagophilus_groenlandica:4.3):2.1):1.5):5.1,Erignathus_barbatus:13):3,(((((Hydrurga_leptonyx:4.3,Leptonychotes_weddellii:4.3):2.5,Ommatophoca_rossii:6.8):0.3,Lobodon_carcinophagus:7.1):2.8,(Mirounga_angustirostris:2.3,Mirounga_leonina:2.3):7.6):1.4,(Monachus_monachus:9.9,(Monachus_schauinslandi:4.9,Monachus_tropicalis:4.9):5):1.4):4.7):7):12.7,Ursidae:35.7):7.7,Canidae:43.4);")
```

###### Plotting Tree:

```{r plotting tree, fig.align='center', fig.height= 9, fig.width= 9, fig.cap="Fig 1: Phylogenetic tree of the Pinnipeds with axis in millions of years based on data from (Hidgon, et. al., 2007)."}
ladderised_tree <- ladderize(tree, right=FALSE) #Used to make it easier to see how the time scale maps onto the tree.
plot(ladderised_tree, cex = 0.7)
axisPhylo(cex = 0.5)
```

This tree shows the 33 extant species of pinnipeds, as well as the now extinct Carribean Monk Seal (*Monachus tropicalis*) in addition to Canidae and Ursidae as the outgroups. *Mustelidae* may have been a more appropriate outgroup as since this study it has been shown that they are the sister family to *Pinnepedia* (Park, et. al., 2024). It also shows Odobenids sitting within the *Otariidae* which is the better supported hypothesis, however it was once thought they might group within *Phocidae* instead (Hidgon, et. al, 2007)

#### Analysis

###### Tree Topology:

Although these features can often be inferred from looking at the shape of the tree I decided to test for both whether the tree was ultrametric and bifurcating.

```{r testing if tree is ultrametric and bifurcating}
is.ultrametric(tree)
is.binary(tree)
```

The tree being ultrametric was expected as this is a tree of all extant pinnipeds and both of the outgroups used are also clades that still exist today so all of the branches should continue until the present day.

Although it does match the observed branching pattern of the tree it was slightly unexpected that the tree was found to be bifurcating. This is because this suggeststhe tree contains no polytomies. This is interesting however as it has been suggested that polytomies could exist both at the basal end of the tribe *Phocini* (one of three tribes that make up the *Phocinae* subfamily of earless/true seals) and potentially within the genus *Pusa* (Hidgon, et. al., 2007).

It is also important to check these as some of the functions used to analyse tree metrics assume that trees are ultrametric and bifurcating.

###### Phylogenetic diversity:

```{r Whole tree phylogenetic diversity}
sum(tree$edge.length)
```

As the branch lengths in this tree are based on divergence dates in millions of years the total sum of branch lengths can be used to indicate the total amount of evolutionary history which is contained within this tree. This shows that this tree contains 319.8 years of evolutionary history, however this also includes the *Canidae* and *Ursidae* out groups.

From this point forward the tree containing no outgroups will be used so that analyses are concerning solely the pinnipeds.

```{r Creating tree without outgroups, echo=FALSE}
tree <- drop.tip(tree, c("Canidae", "Ursidae")) #would ignore/not run this step if you do not need to remove outgroups from tree
```

```{r Pinniped phylogenetic diversity calculation, echo=FALSE}
phylo_div <- sum(tree$edge.length)
```

```{r Phylogenetic Diversity}
phylo_div
```


Running this without the outgroups included shows that from the last common pinniped ancestor there is 220.3 million years of evolutionary history conserved.

###### Tree Imbalance:

```{r Function for calculating imbalance metric, echo=FALSE}
imbalance_metric <-function (tree) {
x<-balance(tree)
for (i in (1:nrow(x))) {
if (x[i,1]<x[i,2]) {
x[i,1:2]<- x[i,2:1]}
}
return(mean(x[,1]/(x[,1]+x[,2])))}
```

```{r Pinniped Imbalance Metric Calculation, echo=FALSE}
imbalance <- imbalance_metric(tree)
```

```{r Imbalance Metric}
imbalance
```


Imbalance metric is 0.70, showing that while the tree is not completely balanced it is still overall more balanced than unbalanced. It also suggests there is a slight tendency for progressive branching, which can be seen specifically in the genus *Arctocephalus* and also the tribe *Phocina* (includes the genus *Phoca* as well as *Halicheoeris grypus*).

###### Speciation Rate:

Speciation rate can calculated by fitting the yule process to a tree which will allow you to calculate the instantaneous speciation rate λ, which can be multiplied by the number of species to calculate the total speciation rate (Crawford & Suchard, 2013)

```{r Speciation Rate Calculation, echo=FALSE}

number_of_species <- Nnode(tree) + 1 #Nnode + 1 represents the number of species

yule_result <- yule(tree)
speciation_rate <- yule_result$lambda* number_of_species 
```

```{r Speciation Rate}
speciation_rate
```


## Summary of Metrics

###### Metrics Table: 

```{r Setting up Table, echo=FALSE}
tree_metrics_matrix <- matrix(c(phylo_div, imbalance, speciation_rate), ncol = 3, byrow = TRUE, nrow = 1)

colnames(tree_metrics_matrix) <- c('Phylogenetic Diversity','Imbalance','Speciation Rate')
rownames(tree_metrics_matrix) <- "Values"

metric_table <- as.table(tree_metrics_matrix)

```

```{r Table, echo=FALSE, fig.align='center', fig.height= 9, fig.width= 9,fig.cap="Fig 2: Table summarising various metrics associated with the phylogenetic tree."}
knitr::kable(tree_metrics_matrix)
#Kable is used to tell R markdown to create a figure formatted as a table
```
## Evolutionary Diversity per Tip

```{r calculating evolutionary diversity for each tip, echo =FALSE}

tip_length_list <- capture.output(
  for(i in 1:number_of_species) {
terminal.branch<-which(tree$edge[,2]== i)
terminal_diversity <- (tree$edge.length[terminal.branch])
cat(terminal_diversity, "\n")
   } 
)

#The for loop here prints a the tip length for each succesive value of i from 1 to the total number of species.
#Capture.output is used to save the results of each result printed (otherwise they are overwritten each time the for loop runs for the next value of i)

#cat is used an an alternative to print as it does not output [1] so only the tip length is saved by capture.output.
#/n is needed to tell cat to create a new line after each tip lenght, otherwise it prints them all as one continuous string of numbers.

```

```{r creating dataframe from  for loop outputs, echo = FALSE}
tip_length_list <- as.numeric(tip_length_list) #the output of cat is character data, this must be converted into numerical data so that it can then be converted into a dataframe.

tip_evo_div_data <- as.data.frame(tip_length_list) #converting tip lengths into a dataframe so it can be plotted
new.names <- gsub("_"," ",tree$tip.label) # Changing the species names so they are in the format Genus species rather than Genus_species
tip_evo_div_data$species <- new.names #adding a coloumn for species names into the dataset.
```

```{r Creating Quartile Column, echo = FALSE}
med <- median(tip_evo_div_data$tip_length_list)
first_quartile <- quantile(tip_evo_div_data$tip_length_list, 0.25)
third_quartile <- quantile(tip_evo_div_data$tip_length_list, 0.75)

#saving the values of Q1, Q3 and the median as objects

quartile_table <- tip_evo_div_data %>% mutate(Quartile =
                     case_when(tip_length_list >= third_quartile ~ "≥ 75th Percentile", 
                               tip_length_list >= med ~ "≥ 50th Percentile",
                               tip_length_list >= first_quartile ~ "≥ 25th Percentile",
                               tip_length_list < first_quartile ~ "< 25th Percentile"
                               )
)

# Creating a new table with an extra column classifying species into which quarter of the dataset they fall into based on their branch length.
```

```{r Rearranging the order of factors, echo=FALSE}
quartile_table$Quartile <- factor(quartile_table$Quartile, levels = c("≥ 75th Percentile", "≥ 50th Percentile","≥ 25th Percentile", "< 25th Percentile") )
```

###### Bar Chart:

```{r plotting evolutionary diversity of tips, echo=FALSE, fig.width=10, fig.height=6, fig.cap = "Fig 3: Bar Chart showing the Evolutionary Diversity of each tip"}

 ggplot(data = quartile_table) +
  geom_col(aes(x=species, y=tip_length_list, fill = Quartile)) +
    scale_x_discrete(labels = label_wrap(10)) +
  labs(x = "Species", y = "Tip Branch Length", 
       title = "Unique evolutionary history of each tip as measured by the branch length") +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.5, vjust = 0.5, size = 6, face = "bold.italic"), plot.title = element_text(hjust = 0.5, face ="bold"), legend.title = element_blank()) + 
  scale_fill_manual(values = c("#EF9007", "#F6D317", "#45BCEE", "#2B6987"))
 
```

The species contributing most to the phylogenetic diversity of the pinnipeds are *Odobenus rosmarus*, *Erignathus barbatus* and *Monachus monachus* respectively. The walrus tip having the most phylogenetic diversity is not suprising as it is the only living member of its family. Aside from the walrus, overall 7 of the 25% most phylogenetially diverse tips were from the the Phocids versus only 2 from the Otariids. This suggests that the extant *Phocinae* might have contributed more to evolutionary history than the *Otaridae*.

